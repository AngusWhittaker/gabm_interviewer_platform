{% extends "base.html" %}
{% load static %}
{% load crispy_forms_tags %}

{% block custom_head_content %}
  <style>
    .module-title {
      font-weight:800;
    }

    #consent_form input {
      margin-bottom:1.2em
    }

    .active_module {
      border-width:3px !important;
      border-color: #F72C25 !important;
    }
  </style>

  <link rel="stylesheet" href="{% static 'gabm/sneat/assets/vendor/libs/select2/select2.css' %}" />
  <link rel="stylesheet" href="{% static 'gabm/sneat/assets/vendor/libs/@form-validation/umd/styles/index.min.css' %}" />
  <link rel="stylesheet" href="{% static 'gabm/sneat/assets/vendor/libs/bs-stepper/bs-stepper.css' %}" />
{% endblock custom_head_content %}

{% block content %}
  <div class="content-wrapper">

    <div class="container-xxl flex-grow-1 container-p-y">
      <h4 class="py-3 mb-4">Study Components and Instructions</h4>

      <div class="card g-3 mt-5" style="margin-top:0em !important">
        <div class="card-body row g-3">
          
          <div class="col-lg-8">

            <div class="card-body">
              <div class="added-cards">

                <div class="cardMaster border p-3 rounded mb-3 {% if curr_module == 'Consent' %}active_module{% endif %}">
                  <div class="d-flex justify-content-between flex-sm-row flex-column">
                    <div class="card-information">
                      <p>
                        <i class="menu-icon tf-icons bx bx-file"></i>
                        Preparation
                      </p>
                      <div class="d-flex align-items-center mb-1">
                        <h6 class="mb-0 me-3 module-title">Review the Consent Form</h6>
                        {% if curr_module == "Consent" %}
                          <span class="badge bg-label-primary me-1">Do this next!</span>
                        {% endif %}
                      </div>
                      <span>
                        TODO
                        Deadline, etc
                      </span>
                    </div>
                    <div class="d-flex flex-column text-start text-lg-end">
                      <div class="d-flex order-sm-0 order-1">
                        {% if curr_module == "Consent" %}
                          <button type="button" class="btn btn-label-primary" data-bs-toggle="modal" data-bs-target="#consentForm">Start the Module</button>
                        {% elif "Consent" in completed_modules %}
                          <button class="btn btn-label-secondary" disabled>Done</button>
                        {% else %}
                          <button class="btn btn-label-secondary" disabled>Start the Module</button>
                        {% endif %}
                      </div>
                      <small class="mt-sm-auto mt-2 order-sm-1 order-0">Est. 5 minutes</small>
                    </div>
                  </div>
                </div>

                <div class="cardMaster border p-3 rounded mb-3 {% if curr_module == 'Interview' %}active_module{% endif %}">
                  <div class="d-flex justify-content-between flex-sm-row flex-column">
                    <div class="card-information">
                      <p>
                        <i class="menu-icon tf-icons bx bx-chat"></i>
                        Step 1
                      </p>
                      <div class="d-flex align-items-center mb-1">
                        <h6 class="mb-0 me-3 module-title">Join the Interview</h6>
                        {% if curr_module == "Interview" %}
                          <span class="badge bg-label-primary me-1">Do this next!</span>
                        {% endif %}
                      </div>
                      <span>
                        TODO
                        Deadline, etc
                      </span>
                    </div>
                    <div class="d-flex flex-column text-start text-lg-end">
                      <div class="d-flex order-sm-0 order-1">
                        {% if curr_module == "Interview" %}
                          <button type="button" class="btn btn-label-primary" data-bs-toggle="modal" data-bs-target="#createApp">Start the Module</button>
                        {% elif "Interview" in completed_modules %}
                          <button class="btn btn-label-secondary" disabled>Done</button>
                        {% else %}
                          <button class="btn btn-label-secondary" disabled>Start the Module</button>
                        {% endif %}
                      </div>
                      <small class="mt-sm-auto mt-2 order-sm-1 order-0">Est. 2 hours</small>
                    </div>
                  </div>
                </div>

                <div class="cardMaster border p-3 rounded mb-3 {% if curr_module == 'Survey Pt.1' %}active_module{% endif %}">
                  <div class="d-flex justify-content-between flex-sm-row flex-column">
                    <div class="card-information">
                      <p>
                        <i class="menu-icon tf-icons bx bx-notepad"></i>
                        Step 2
                      </p>
                      <div class="d-flex align-items-center mb-1">
                        <h6 class="mb-0 me-3 module-title">Take the Survey -- Pt 1.</h6>
                        {% if curr_module == "Survey Pt.1" %}
                          <span class="badge bg-label-primary me-1">Do this next!</span>
                        {% endif %}
                      </div>
                      <span>
                        TODO
                        Deadline, etc
                      </span>
                    </div>
                    <div class="d-flex flex-column text-start text-lg-end">
                      <div class="d-flex order-sm-0 order-1">
                        <div class="d-flex order-sm-0 order-1">
                          {% if curr_module == "Survey Pt.1" %}
                            <button type="button" class="btn btn-label-primary">Start the Module</button>
                          {% elif "Survey Pt.1" in completed_modules %}
                            <button class="btn btn-label-secondary" disabled>Done</button>
                          {% else %}
                            <button class="btn btn-label-secondary" disabled>Start the Module</button>
                          {% endif %}
                        </div>
                      </div>
                      <small class="mt-sm-auto mt-2 order-sm-1 order-0">Est. 40 minutes</small>
                    </div>
                  </div>
                </div>

                <div class="cardMaster border p-3 rounded mb-3 {% if curr_module == 'Survey Pt.2' %}active_module{% endif %}">
                  <div class="d-flex justify-content-between flex-sm-row flex-column">
                    <div class="card-information">
                      <p>
                        <i class="menu-icon tf-icons bx bx-notepad"></i>
                        Step 3
                      </p>
                      <div class="d-flex align-items-center mb-1">
                        <h6 class="mb-0 me-3 module-title">Take the Survey -- Pt 2.</h6>
                        {% if curr_module == "Survey Pt.2" %}
                          <span class="badge bg-label-primary me-1">Do this next!</span>
                        {% endif %}
                      </div>
                      <span>
                        This will become available after x date. 
                      </span>
                    </div>
                    <div class="d-flex flex-column text-start text-lg-end">
                      <div class="d-flex order-sm-0 order-1">
                        <div class="d-flex order-sm-0 order-1">
                          {% if curr_module == "Survey Pt.2" %}
                            <button type="button" class="btn btn-label-primary">Start the Module</button>
                          {% elif "Survey Pt.2" in completed_modules %}
                            <button class="btn btn-label-secondary" disabled>Done</button>
                          {% else %}
                            <button class="btn btn-label-secondary" disabled>Start the Module</button>
                          {% endif %}
                        </div>
                      </div>
                      <small class="mt-sm-auto mt-2 order-sm-1 order-0">Est. 40 minutes</small>
                    </div>
                  </div>
                </div>

              </div>
            </div>
          </div>


          <div class="col-lg-4">
            <div class="card-header align-items-center">
              <h5 class="card-action-title mb-0">Study Instructions</h5>
            </div>
            <div class="card-body">
              <small class="text-muted text-uppercase">About</small>
              <p>testset</p>
              <small class="text-muted text-uppercase">About</small>
              <p>testset</p>
            </div>
          </div>

        </div>
      </div>

    </div>
  </div>
{% endblock content %}


{% block modal_block %}
  <!-- Consent Form Modal -->
  <div class="modal fade" id="consentForm" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-md modal-simple modal-edit-user">
      <div class="modal-content p-3 p-md-5">
        <div class="modal-body">
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          <div class="text-center mb-4">
            <h3>Consent Form</h3>
            <p>TODO: Include a link to the consent form... temp link: <a href="https://docs.google.com/document/d/1BuuySmc8TSnAmwMvO1wisANiE2WruLEGojSDikor28U/edit?usp=sharing" target="_blank">Consent Form</a></p>
          </div>
          <form id="consent_form" action="{% url 'handler_consent' %}" method="post">
            {% csrf_token %}
            {{ consent_form|crispy }}
            <br>
            <button type="submit" class="btn btn-primary me-sm-3 me-1" style="width:100%">I consent to participating in the study</button>
          </form>
        </div>
      </div>
    </div>
  </div>
  <!--/ Consent Form Modal -->

  <!-- Join the interview Modal -->
  <div class="modal fade" id="createApp" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-simple modal-upgrade-plan">
      <div class="modal-content p-3 p-md-5">
        <div class="modal-body p-2">
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          <div class="text-center">
            <h3 class="mb-2">Are you ready to start the interview?</h3><br>
          </div>
          <!-- App Wizard -->
          <div id="wizard-create-app" class="bs-stepper vertical mt-2 shadow-none border-0">
            <div class="bs-stepper-header border-0 p-1">
              
              <div class="step" data-target="#details">
                <button type="button" class="step-trigger" disabled>
                  <span class="bs-stepper-circle"><i class="bx bx-file fs-5"></i></span>
                  <span class="bs-stepper-label">
                    <span class="bs-stepper-title text-uppercase">Test Audio</span>
                  </span>
                </button>
              </div>

              <div class="line"></div>
              <div class="step" data-target="#calibrationSubmit">
                <button type="button" class="step-trigger" disabled>
                  <span class="bs-stepper-circle"><i class="bx bx-check fs-5"></i></span>
                  <span class="bs-stepper-label">
                    <span class="bs-stepper-title text-uppercase">Start</span>
                  </span>
                </button>
              </div>

            </div>
            <div class="bs-stepper-content p-1">
              <div id="details" class="content pt-3 pt-lg-0">
                <p>Before we start, we want to make sure that your audio is working properly! Please find a quiet place with a microphone. When you are ready, 1) press the "Start calibration" button below, and 2) read out loud the lines below.</p>

                <div class="mb-3" style="border:solid; border-radius: 1.2em; padding:1.2em">
                  <div style="margin-bottom:1.2em; margin-top:0.8em">
                    <button id="calibrateButton" class="btn btn-outline-dark">
                      Start calibration
                    </button>
                  </div>
                  <p>
                    <em>Please read out loud (repeat if needed)</em>: In my younger and more vulnerable years my father gave me some advice that I've been turning over in my mind ever since. Whenever you feel like criticizing anyone, he told me, just remember that all the people in this world haven't had the advantages that you've had.
                  </p>
                  <p style="margin-bottom:1.2em; ">
                    <em>(Progress: <span id="calibrationProgress">0</span>% completed)</em>
                  </p>
                </div>
                
                <p><br>Please press the next button below when you have completed the calibration step. </p>

                <div class="col-12 d-flex justify-content-between mt-4">
                  <button id="interviewPrepStepOneDoneButton" class="btn btn-primary btn-next" style="width:100%" disabled>
                    <span class="align-middle d-sm-inline-block d-none me-sm-1">Next</span>
                    <i class="bx bx-right-arrow-alt bx-xs"></i>
                  </button>
                </div>

              </div>

              <!-- submit -->
              <div id="calibrationSubmit" class="content text-center pt-3 pt-lg-0">
                <h5 class="mb-2 mt-3">Submit</h5>
                <p>Submit to kick start your project.</p>
                <!-- image -->
                <img
                  src="{% static 'gabm/sneat/assets/img/illustrations/man-with-laptop-light.png' %}"
                  alt="Create App img"
                  width="200"
                  class="img-fluid"
                  data-app-light-img="illustrations/man-with-laptop-light.png"
                  data-app-dark-img="illustrations/man-with-laptop-dark.png" />
                <div class="col-12 d-flex justify-content-between mt-4 pt-2">
                  <form method="post" action="{% url 'handler_calibration' %}" style="width: 100%;">
                    {% csrf_token %}
                    <input type="hidden" name="audioCalibrationFloat" value="hiddenValue-testetest">
                    <button type="submit" class="btn btn-success" style="width:100%">I am ready to start the interview</button>
                  </form>
                </div>
              </div>
            </div>
          </div>
        </div>
        <!--/ App Wizard -->
      </div>
    </div>
  </div>
  <!--/ Join the interview Modal -->

{% endblock modal_block %}



{% block js_content %}
  <script src="{% static 'gabm/sneat/assets/vendor/libs/cleavejs/cleave.js' %}"></script>
  <script src="{% static 'gabm/sneat/assets/vendor/libs/cleavejs/cleave-phone.js' %}"></script>
  <script src="{% static 'gabm/sneat/assets/vendor/libs/select2/select2.js' %}"></script>
  <script src="{% static 'gabm/sneat/assets/vendor/libs/@form-validation/umd/bundle/popular.min.js' %}"></script>
  <script src="{% static 'gabm/sneat/assets/vendor/libs/@form-validation/umd/plugin-bootstrap5/index.min.js' %}"></script>
  <script src="{% static 'gabm/sneat/assets/vendor/libs/@form-validation/umd/plugin-auto-focus/index.min.js' %}"></script>
  <script src="{% static 'gabm/sneat/assets/vendor/libs/bs-stepper/bs-stepper.js' %}"></script>

  <script src="{% static 'gabm/sneat/assets/js/modal-create-app.js' %}"></script>
  <script>
      let audioContext = new (window.AudioContext || window.webkitAudioContext)();

      // Settings and parameters: 
      let calibrationBufferDuration = 50; 
      let calibrationSlackRate = 0.5;
      let silenceGuaranteeThreshold = 0.01;
      let speechThreshold = 0.02;
      let speechThresholdCalibrated = false;

      document.getElementById('calibrateButton').addEventListener('click', function() {
        document.getElementById("calibrateButton").innerText = "Calibrating the audio";
        document.getElementById("calibrateButton").disabled = true;

        let list_buffer_rms = [];

        // Check for non-null
        if (navigator.mediaDevices.getUserMedia) {
            navigator.mediaDevices.getUserMedia ({audio: true})
            .then(function(stream) {
              const audioContext = new (window.AudioContext || window.webkitAudioContext)();
              const source = audioContext.createMediaStreamSource(stream);
              const processor = audioContext.createScriptProcessor(4096, 1, 1);

              source.connect(processor);
              processor.connect(audioContext.destination);

              processor.onaudioprocess = function(e) {
                // Get the buffer of audio data
                const buffer = e.inputBuffer.getChannelData(0);

                // Root Mean Square (RMS) is a statistical measure of the 
                // magnitude of a varying quantity. It's commonly used in 
                // physics, engineering, and signal processing to represent 
                // the average power or amplitude of a signal, especially 
                // when it varies over time.
                let sum = 0;
                for(let i = 0; i < buffer.length; i++) {
                    sum += buffer[i] * buffer[i]; // sum of squares
                }
                let rms = Math.sqrt(sum / buffer.length);
                // Update the average noise level display/processing
                console.log("Current RMS: " + rms);

                if (rms > silenceGuaranteeThreshold) {
                  list_buffer_rms.push(rms);

                  var element = document.getElementById('calibrationProgress');
                  var currentNumber = parseInt(element.innerText);
                  currentNumber += 100/calibrationBufferDuration; 
                  element.innerText = currentNumber;
                }; 

                if (list_buffer_rms.length >= calibrationBufferDuration) {
                  // Disconnecting the processor and source for now. 
                  processor.disconnect();
                  source.disconnect();
                  // Calibrating the threshold. 
                  let sum = list_buffer_rms.reduce(function (accumulator, currentValue) {
                      return accumulator + currentValue;
                  }, 0);

                  let rms_average = sum / list_buffer_rms.length;
                  speechThreshold = rms_average * calibrationSlackRate;
                  speechThresholdCalibrated = true;
                  // Removing the event listener.
                  processor.onaudioprocess = null;
                  console.log("Stopping the calibration process");
                  console.log("New speechThreshold" + speechThreshold);
                  document.getElementById("interviewPrepStepOneDoneButton").disabled = false;
                  document.getElementsByName("audioCalibrationFloat")[0].value = speechThreshold;
                  document.getElementById("calibrateButton").innerText = "Finished calibrating the audio";

                  processor.disconnect();
                  source.disconnect();
                  audioContext.close(); // Optionally close the context if it's no longer needed
                };
              };
            })
            .catch(function(err) {
              console.log('The following gUM error occurred: ' + err);
            });
        } else {
           console.log('getUserMedia not supported on your browser!');
        }
      });
      
    </script>
{% endblock js_content %}

















